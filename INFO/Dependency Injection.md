---
created: 2025-02-04-13-38-23+10:00
tags:
---
# MSDN
https://learn.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-9.0

---

**Dependency Injection (DI)** ‚Äî —ç—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **Inversion of Control (IoC)**, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–º —Å–∞–º–∏–º, –∞ **"–≤–Ω–µ–¥—Ä—è—é—Ç—Å—è" –∏–∑–≤–Ω–µ**. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –±–æ–ª–µ–µ –≥–∏–±–∫–∏–º, —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º –∏ –º–æ–¥—É–ª—å–Ω—ã–º.

---

### –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∞–ª–æ–≥–∏—è üçî
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –∑–∞–∫–∞–∑—ã–≤–∞–µ—Ç–µ –ø–∏—Ü—Ü—É:
- **–ë–µ–∑ DI**: –í—ã —Å–∞–º–∏ –≤—ã—Ä–∞—â–∏–≤–∞–µ—Ç–µ –æ–≤–æ—â–∏, –ø–µ—á–µ—Ç–µ —Ç–µ—Å—Ç–æ, –≥–æ—Ç–æ–≤–∏—Ç–µ —Å–æ—É—Å.
- **–° DI**: –í–∞–º –ø—Ä–∏–≤–æ–∑—è—Ç –≥–æ—Ç–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏), –∏ –≤—ã —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞–µ—Ç–µ –ø–∏—Ü—Ü—É.

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?
### –ë–µ–∑ DI (–ñ–µ—Å—Ç–∫–∞—è —Å–≤—è–∑—å)
```csharp
public class ProductHandler
{
    private readonly JsonProductRepository _repository;

    public ProductHandler()
    {
        // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Å–∞
        _repository = new JsonProductRepository(); 
    }
}
```
**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SqlProductRepository`, –ø—Ä–∏–¥–µ—Ç—Å—è –º–µ–Ω—è—Ç—å –∫–æ–¥ `ProductHandler`.

---

### –° DI (–ì–∏–±–∫–∞—è —Å–≤—è–∑—å)
```csharp
public class ProductHandler
{
    private readonly IProductRepository _repository;

    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    public ProductHandler(IProductRepository repository)
    {
        _repository = repository; // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∏–∑–≤–Ω–µ
    }
}
```
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ö–ª–∞—Å—Å –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `IProductRepository`.
- –õ–µ–≥–∫–æ –ø–æ–¥–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ç–µ—Å—Ç–æ–≤).

---

## 3 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∏–ø–∞ DI
1. **–ß–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä** (–Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π):
   ```csharp
   public class MyService
   {
       private readonly IDependency _dep;
       public MyService(IDependency dep) => _dep = dep;
   }
   ```

2. **–ß–µ—Ä–µ–∑ —Å–≤–æ–π—Å—Ç–≤–∞**:
   ```csharp
   public class MyService
   {
       public IDependency Dep { get; set; }
   }
   ```

3. **–ß–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã**:
   ```csharp
   public class MyService
   {
       public void Initialize(IDependency dep) { ... }
   }
   ```

---

## –ü–æ—á–µ–º—É DI –≤–∞–∂–µ–Ω?
4. **–£–º–µ–Ω—å—à–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (Low Coupling)**:
   - –ö–ª–∞—Å—Å—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (`–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤`), –∞ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π.

5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**:
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å mock-–æ–±—ä–µ–∫—Ç—ã –≤ —Ç–µ—Å—Ç–∞—Ö:
   ```csharp
   var mockRepo = new Mock<IProductRepository>();
   var handler = new ProductHandler(mockRepo.Object);
   ```

6. **–ì–∏–±–∫–æ—Å—Ç—å**:
   - –ó–∞–º–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ DI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

7. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º**:
   - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã (Singleton, Scoped, Transient).

---

## DI –≤ ASP.NET Core
8. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** (–≤ `Program.cs`):
```csharp
builder.Services.AddScoped<IProductRepository, JsonProductRepository>();
builder.Services.AddTransient<ProductHandler>();
```

9. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ** –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã:
```csharp
public class ProductsController : ControllerBase
{
    private readonly ProductHandler _handler;

    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è
    public ProductsController(ProductHandler handler) 
    {
        _handler = handler;
    }
}
```

---

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
| –¢–∏–ø         | –û–ø–∏—Å–∞–Ω–∏–µ                                                                 |
|-------------|-------------------------------------------------------------------------|
| **Transient** | –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`AddTransient`)           |
| **Scoped**    | –û–¥–∏–Ω –æ–±—ä–µ–∫—Ç –Ω–∞ –æ–±–ª–∞—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, HTTP-–∑–∞–ø—Ä–æ—Å) (`AddScoped`)           |
| **Singleton** | –û–¥–∏–Ω –æ–±—ä–µ–∫—Ç –Ω–∞ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`AddSingleton`)                         |

–ü—Ä–∏–º–µ—Ä:
```csharp
services.AddSingleton<ICacheService, CacheService>(); // –û–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
services.AddScoped<IUserContext, UserContext>(); // –û–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –∑–∞–ø—Ä–æ—Å
services.AddTransient<IEmailService, EmailService>(); // –ù–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–∞–∂–¥—ã–π —Ä–∞–∑
```

---

## –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
10. **–°–µ—Ä–≤–∏—Å-–ª–æ–∫–∞—Ç–æ—Ä (Service Locator)**:
   ```csharp
   // –ü–ª–æ—Ö–æ: —Å–∫—Ä—ã—Ç–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
   var repo = ServiceLocator.Get<IProductRepository>();
   ```
   - –ù–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø —è–≤–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

11. **–¶–µ–ø–æ—á–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**:
   - –ò–∑–±–µ–≥–∞–π—Ç–µ –≥–ª—É–±–æ–∫–∏—Ö —Ü–µ–ø–æ—á–µ–∫ –≤–∏–¥–∞ `A -> B -> C -> D`. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞—Å–∞–¥—ã.

12. **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
   - `ClassA` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `ClassB`, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `ClassA`. –†–µ—à–µ–Ω–∏–µ: —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥.

---

## –ü—Ä–∏–º–µ—Ä: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å DI
```csharp
// –¢–µ—Å—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Moq
[Test]
public void GetProducts_ReturnsFilteredList()
{
    // Arrange
    var mockRepo = new Mock<IProductRepository>();
    mockRepo.Setup(r => r.GetProducts()).Returns(new List<Product> { ... });
    
    var handler = new ProductHandler(mockRepo.Object); // –í–Ω–µ–¥—Ä—è–µ–º mock
    
    // Act
    var result = handler.Get();
    
    // Assert
    Assert.That(result.Count, Is.EqualTo(1));
}
```

---

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DI?
- –í –ø—Ä–æ–µ–∫—Ç–∞—Ö —Å—Ä–µ–¥–Ω–µ–π –∏ –±–æ–ª—å—à–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.
- –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.
- –î–ª—è –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–æ–∫—Ä—ã–≤–∞—Ç—å unit-—Ç–µ—Å—Ç–∞–º–∏.

## –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?
- –í –º–∏–∫—Ä–æ—Å–∫–æ–ø–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã).
- –ï—Å–ª–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É—Å–ª–æ–∂–Ω–∏—Ç –∫–æ–¥ –±–µ–∑ –≤–∏–¥–∏–º–æ–π –ø–æ–ª—å–∑—ã.

---

## –ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ DI:
**"–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —è–≤–Ω—ã–º–∏"**  
–ï—Å–ª–∏ –∫–ª–∞—Å—Å —Ç—Ä–µ–±—É–µ—Ç –∫–∞–∫–∏–µ-—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã ‚Äî –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —è–≤–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω—ã (—á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä, —Å–≤–æ–π—Å—Ç–≤–∞ –∏–ª–∏ –º–µ—Ç–æ–¥—ã).


